From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: etil2jz <blanchot.arthur@protonmail.ch>
Date: Thu, 5 May 2022 11:14:27 +0200
Subject: [PATCH] Fix villagers being hurt by their own fireworks

Villagers can get hit by their own fireworks in rare cases.
See https://bugs.mojang.com/browse/MC-195326 & https://bugs.mojang.com/browse/MC-233250.

diff --git a/src/main/java/net/minecraft/world/entity/npc/Villager.java b/src/main/java/net/minecraft/world/entity/npc/Villager.java
index b5db8212aa6b20fbaa8ea7dbcd14c9cc13460fe0..c543ce86a2bd8c3219d9ce43d5ffac70bda2933b 100644
--- a/src/main/java/net/minecraft/world/entity/npc/Villager.java
+++ b/src/main/java/net/minecraft/world/entity/npc/Villager.java
@@ -793,6 +793,14 @@ public class Villager extends AbstractVillager implements ReputationEventHandler
         super.die(source);
     }
 
+    // Mirai start - fix villagers being hurt by their own fireworks
+    @Override
+    public boolean hurt(DamageSource source, float amount) {
+        if (source.isProjectile() && source.isExplosion() && Objects.equals(source.getMsgId(), "fireworks") && source.getEntity() instanceof Villager) return false;
+        return super.hurt(source, amount);
+    }
+    // Mirai end
+
     public void releaseAllPois() {
         this.releasePoi(MemoryModuleType.HOME);
         this.releasePoi(MemoryModuleType.JOB_SITE);
